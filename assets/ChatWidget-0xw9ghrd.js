import{r as a,j as t,S as Ue,A as Xe,d as Me,N as Ee,W as M,c as Ze,R as et,f as tt}from"./index-C5Xg2j0t.js";import{c as rt}from"./imageCompressor-D5vYYzIg.js";import{U as xe}from"./UserAvatar-zN-Wxe05.js";import{r as Ie,s as Le}from"./notificationUtils-Daxn_erD.js";import{a as $}from"./dateUtils-MJGiVJEs.js";const st=["audio/mp4","audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"],at=()=>{const[p,C]=a.useState(!1),i=a.useRef(null),x=a.useRef([]),E=a.useRef("audio/webm");return{isRecording:p,startRecording:async()=>{if(!p)try{const h=await navigator.mediaDevices.getUserMedia({audio:!0}),b=st.find(N=>MediaRecorder.isTypeSupported(N));if(!b){alert("Your browser does not support any of the required audio recording formats."),console.error("No supported audio MIME types found.");return}E.current=b,console.log(`Using MIME type for recording: ${b}`),i.current=new MediaRecorder(h,{mimeType:b}),x.current=[],i.current.ondataavailable=N=>{x.current.push(N.data)},i.current.onstop=()=>{h.getTracks().forEach(N=>N.stop())},i.current.start(),C(!0)}catch(h){console.error("Error starting audio recording:",h),h instanceof DOMException&&(h.name==="NotAllowedError"||h.name==="PermissionDeniedError")?alert("áž€áž¶ážšáž¢áž“áž»áž‰áŸ’áž‰áž¶ážáž±áŸ’áž™áž”áŸ’ážšáž¾áž˜áž¸áž€áŸ’ážšáž¼áž áŸ’ážœáž¼áž“ážáŸ’ážšáž¼ážœáž”áž¶áž“áž”ážŠáž·ážŸáŸáž’áŸ” ážŸáž¼áž˜áž¢áž“áž»áž‰áŸ’áž‰áž¶ážáž±áŸ’áž™áž…áž¼áž›áž”áŸ’ážšáž¾áž˜áž¸áž€áŸ’ážšáž¼áž áŸ’ážœáž¼áž“áž“áŸ…áž€áŸ’áž“áž»áž„áž€áž¶ážšáž€áŸ†ážŽážáŸ‹áž€áž˜áŸ’áž˜ážœáž·áž’áž¸ážšáž»áž€ážšáž€ážšáž”ážŸáŸ‹áž¢áŸ’áž“áž€ ážŠáž¾áž˜áŸ’áž”áž¸áž”áŸ’ážšáž¾áž˜áž»ážáž„áž¶ážšáž“áŸáŸ‡áŸ”"):alert("áž˜áž·áž“áž¢áž¶áž…áž…áž¶áž”áŸ‹áž•áŸ’ážáž¾áž˜áž€áž¶ážšážážážŸáŸ†áž¡áŸáž„áž”áž¶áž“áž‘áŸáŸ” ážŸáž¼áž˜áž”áŸ’ážšáž¶áž€ážŠážáž¶áž¢áŸ’áž“áž€áž”áž¶áž“áž—áŸ’áž‡áž¶áž”áŸ‹áž˜áž¸áž€áŸ’ážšáž¼áž áŸ’ážœáž¼áž“ áž áž¾áž™áž”áž¶áž“áž•áŸ’ážáž›áŸ‹áž€áž¶ážšáž¢áž“áž»áž‰áŸ’áž‰áž¶ážáŸ”")}},stopRecording:()=>new Promise(h=>{if(!i.current||!p){h(null);return}i.current.onstop=()=>{const b=new Blob(x.current,{type:E.current});i.current&&i.current.stream.getTracks().forEach(N=>N.stop()),h(b)},i.current.stop(),C(!1)})}},nt=({src:p,isMe:C=!1})=>{const i=a.useRef(null),[x,E]=a.useState(!1),[I,B]=a.useState(0),[h,b]=a.useState(0),[N,H]=a.useState(!1),[V,_]=a.useState(null);a.useEffect(()=>()=>{const l=i.current;l&&(l.pause(),l.removeAttribute("src"),l.load())},[]);const D=l=>{const f=()=>{l.duration&&isFinite(l.duration)&&(B(l.duration),H(!0),_(null))},j=()=>b(l.currentTime),K=()=>{E(!1),b(0)},se=()=>{console.error("Audio Error",l.error),_("Unavailable"),H(!1)};l.onloadedmetadata=f,l.oncanplay=f,l.ontimeupdate=j,l.onended=K,l.onerror=se},A=()=>{const l=i.current;if(l){if(!N&&!x&&!V){D(l),document.querySelectorAll("audio").forEach(f=>{f!==l&&f.pause()}),l.play().then(()=>{E(!0),H(!0)}).catch(f=>{console.error("Play failed",f),_("Unavailable")});return}x?(l.pause(),E(!1)):(document.querySelectorAll("audio").forEach(f=>{f!==l&&f.pause()}),l.play().catch(f=>console.error("Play failed",f)),E(!0))}},k=l=>{const f=parseFloat(l.target.value);i.current&&(i.current.currentTime=f,b(f))},L=l=>{if(!isFinite(l)||l<0)return"0:00";const f=Math.floor(l/60),j=Math.floor(l%60);return`${f}:${j<10?"0":""}${j}`};return V?t.jsx("div",{className:"text-[10px] text-red-300 bg-red-900/20 px-2 py-1 rounded",children:"Audio Unavailable"}):t.jsxs("div",{className:`flex items-center gap-3 pr-4 pl-1 py-1 rounded-full min-w-[220px] transition-all ${C?"text-blue-100":"text-gray-600 dark:text-gray-300"}`,children:[t.jsx("audio",{ref:i,src:p,preload:"metadata"}),t.jsx("button",{onClick:A,disabled:!N,className:`w-9 h-9 flex items-center justify-center rounded-full shadow-md transition-all active:scale-95 flex-shrink-0 ${C?"bg-white text-blue-600 hover:bg-gray-100":"bg-blue-600 text-white hover:bg-blue-500"}`,children:N?x?t.jsx("svg",{className:"w-3.5 h-3.5 fill-current",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})}):t.jsx("svg",{className:"w-3.5 h-3.5 fill-current ml-0.5",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M8 5v14l11-7z"})}):t.jsx(Ue,{size:"sm"})}),t.jsxs("div",{className:"flex flex-col flex-grow justify-center gap-1 min-w-[120px]",children:[t.jsx("input",{type:"range",min:"0",max:I||100,value:h,onChange:k,className:`w-full h-1.5 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-0 ${C?"bg-blue-800/30 accent-white":"bg-gray-300 dark:bg-gray-600 accent-blue-600"}`}),t.jsxs("div",{className:"flex justify-between w-full text-[10px] font-mono font-medium opacity-90 px-0.5",children:[t.jsx("span",{children:L(h)}),t.jsx("span",{children:L(I)})]})]})]})},ot=({users:p,loading:C,onRefresh:i})=>C?t.jsxs("div",{className:"flex flex-col items-center justify-center py-10 space-y-3",children:[t.jsx("div",{className:"w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),t.jsx("span",{className:"text-xs text-gray-500",children:"Loading members..."})]}):!p||p.length===0?t.jsxs("div",{className:"text-center text-gray-500 py-10 flex flex-col items-center",children:[t.jsx("p",{className:"text-xs uppercase tracking-widest mb-2",children:"(No members found)"}),t.jsx("button",{onClick:i,className:"text-[10px] text-blue-400 hover:text-white underline",children:"Retry Loading"})]}):t.jsx("div",{className:"p-4 space-y-3 animate-fade-in",children:p.map(x=>t.jsxs("div",{className:"flex items-center gap-4 p-3 rounded-2xl bg-gray-800/40 border border-white/5 hover:bg-gray-800 transition-colors cursor-default group",children:[t.jsx(xe,{avatarUrl:x.ProfilePictureURL,name:x.FullName,size:"md",className:"ring-2 ring-blue-500/20 group-hover:ring-blue-500/50 transition-all"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-black text-white",children:x.FullName}),t.jsxs("p",{className:"text-[10px] text-gray-500 font-mono uppercase tracking-wider",children:["@",x.UserName]})]}),t.jsx("div",{className:"ml-auto flex flex-col items-end gap-1",children:t.jsx("div",{className:`w-2 h-2 rounded-full ${x.IsSystemAdmin?"bg-yellow-500 shadow-[0_0_5px_#eab308]":"bg-blue-500 shadow-[0_0_5px_#3b82f6]"}`})})]},x.UserName))}),it=et.memo(nt),pt=({isOpen:p,onClose:C})=>{const{currentUser:i,appData:x,previewImage:E,setUnreadCount:I,showNotification:B,advancedSettings:h}=a.useContext(Xe),b=a.useMemo(()=>i?`chatHistoryCache_${i.UserName}`:null,[i]),{isRecording:N,startRecording:H,stopRecording:V}=at(),[_,D]=a.useState(0),A=a.useRef(null),k=a.useRef(null),L=a.useRef(null);a.useEffect(()=>{k.current=new Audio(Me.NOTIFICATION),L.current=new Audio(Me.SENT)},[]);const[l,f]=a.useState(()=>{if(!b)return[];try{const e=localStorage.getItem(b);return e&&e!=="undefined"?JSON.parse(e):[]}catch{return[]}}),[j,K]=a.useState([]),[se,ae]=a.useState(!1),[J,Q]=a.useState(""),[$e,ge]=a.useState(!1),[ye,ne]=a.useState(!1),[O,De]=a.useState(()=>localStorage.getItem("chatMuted")==="true"),[W,be]=a.useState(!1),[Ae,oe]=a.useState("disconnected"),[U,we]=a.useState("chat"),[Pe,Fe]=a.useState(!1),[G,ve]=a.useState(""),[Be,ie]=a.useState(!1),[R,le]=a.useState(null),Ne=a.useRef(null),ce=a.useRef(null),P=a.useRef(null),de=a.useRef(null),Y=a.useRef(p),je=a.useRef(j),ue=a.useRef(i),he=a.useRef(O),F=a.useRef(null),fe=a.useRef([]),ke=a.useRef(!1),Re=a.useMemo(()=>l.filter(e=>e.isPinned&&!e.isDeleted),[l]);a.useEffect(()=>{const e=(h==null?void 0:h.notificationSound)||"default",s=Ee.find(o=>o.id===e)||Ee[0],r=(h==null?void 0:h.notificationVolume)??1;k.current&&(k.current.src=s.url,k.current.volume=r),L.current&&(L.current.volume=r)},[h==null?void 0:h.notificationSound,h==null?void 0:h.notificationVolume]),a.useEffect(()=>{je.current=j},[j]),a.useEffect(()=>{ue.current=i},[i]),a.useEffect(()=>{he.current=O},[O]),a.useEffect(()=>{Y.current=p},[p]),a.useEffect(()=>{if(l.length>0&&!F.current){const e=[...l].sort((s,r)=>$(s.timestamp)-$(r.timestamp));F.current=e[e.length-1].id}},[]);const pe=a.useCallback(async()=>{if(x.users&&x.users.length>0){K(x.users),ae(!1);return}ae(!0);try{const s=await(await fetch(`${M}/api/users`)).json();s.status==="success"&&Array.isArray(s.data)&&K(s.data)}catch(e){console.warn("Fallback user fetch failed",e)}finally{ae(!1)}},[x.users]);a.useEffect(()=>{pe()},[pe]),a.useEffect(()=>{p&&I(0)},[p,I]),a.useEffect(()=>{Ie()},[]);const _e=async()=>{await H(),D(0),A.current=setInterval(()=>{D(e=>e+1)},1e3)},Oe=async()=>{await V(),A.current&&clearInterval(A.current),D(0)},We=async()=>{A.current&&clearInterval(A.current),ne(!0);try{const e=await V();if(!e)throw new Error("No audio captured");const s=new FileReader;s.readAsDataURL(e),s.onloadend=async()=>{const o=s.result.split(",")[1];try{const c=await fetch(`${M}/api/upload-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileData:o,fileName:`voice_${Date.now()}.webm`,mimeType:"audio/webm",userName:(i==null?void 0:i.UserName)||"unknown"})}),d=await c.json();if(!c.ok||d.status!=="success")throw new Error(d.message||"Audio upload failed");let n=d.fileId||d.id;if(!n&&d.url){const m=d.url.match(/(?:d\/|id=)([^/?&]+)/);m&&m[1]&&(n=m[1])}if(!n)throw console.error("Could not determine FileID from upload result:",d),new Error("Failed to get File ID");const w=Se(_);await re(w,"audio",n)}catch(c){console.error("Audio Upload Workflow Failed",c),alert("áž€áž¶ážšáž”áž‰áŸ’áž‡áž¼áž“ážŸáž˜áŸ’áž›áŸáž„áž”ážšáž¶áž‡áŸáž™ (Failed to upload audio).")}finally{ne(!1),D(0)}}}catch(e){console.error("Recording Error",e),ne(!1),D(0)}},Se=e=>{const s=Math.floor(e/60),r=e%60;return`${s}:${r<10?"0":""}${r}`},X=a.useCallback(e=>{f(s=>{const r=typeof e=="function"?e(s):e;return b&&localStorage.setItem(b,JSON.stringify(r)),r})},[b]),Z=a.useCallback(e=>{const s=je.current.find(c=>c.UserName===e.UserName),r=(e.MessageType||"text").toLowerCase();let o=e.Content;return(r==="audio"||r==="video")&&e.FileID?o=`${M}/api/chat/${r}/${e.FileID}`:r==="image"&&(o=Ze(e.Content)),{id:e.Timestamp,user:e.UserName,fullName:(s==null?void 0:s.FullName)||e.UserName,avatar:(s==null?void 0:s.ProfilePictureURL)||"",content:o,timestamp:e.Timestamp,type:r,fileID:e.FileID,isOptimistic:!1,isDeleted:e.IsDeleted,isPinned:e.IsPinned,replyTo:e.ReplyTo?{id:e.ReplyTo.ID,user:e.ReplyTo.User,content:e.ReplyTo.Content,type:e.ReplyTo.Type}:void 0}},[]),ee=a.useCallback(e=>{if(e.length===0)return;const s=F.current;let r=[];const o=Date.now(),c=120*1e3;if(!s){F.current=e[e.length-1].id;return}const d=e.findIndex(n=>n.id===s);d!==-1?r=e.slice(d+1):r=e.filter(n=>n.id>s),r.forEach(n=>{var T;if(n.user===((T=ue.current)==null?void 0:T.UserName))return;const m=$(n.timestamp);if(o-m>c)return;const y=n.content&&n.content.includes("ðŸ“¢ NEW ORDER:"),g=n.content&&n.content.includes("ðŸ“¢ SYSTEM_ALERT:");if(y||g){let u=n.content;y?u=n.content.replace("ðŸ“¢ NEW ORDER:","").trim():g&&(u=n.content.replace("ðŸ“¢ SYSTEM_ALERT:","").trim()),B(u,"success"),!he.current&&k.current&&(k.current.currentTime=0,k.current.play().catch(S=>console.warn("Audio play failed",S))),Le("áž€áž¶ážšáž€áž˜áŸ’áž˜áž„áŸ‹ážáŸ’áž˜áž¸ ðŸ“¦",u)}else{const u=n.fullName||n.user;let S=n.content;n.type==="image"?S="ðŸ“· Sent an image":n.type==="audio"&&(S="ðŸŽ¤ Sent a voice message"),B(`${u}: ${S}`,"info"),(document.hidden||!Y.current)&&(Le(u,S),Y.current||I(me=>me+1)),!he.current&&k.current&&(k.current.currentTime=0,k.current.play().catch(()=>{}))}}),r.length>0&&(F.current=r[r.length-1].id)},[B,I]),z=a.useCallback(async(e=!1)=>{if(W)return;l.length===0&&Y.current&&be(!0);try{const r=e,o=r?`${M}/api/chat/messages`:`${M}/api/chat/messages?days=2`;r&&(ke.current=!0);const c=await fetch(o);if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const d=await c.json();if(d.status==="success"){const w=d.data.map(Z).sort((u,S)=>$(u.timestamp)-$(S.timestamp));ee(w);const m=new Date;m.setDate(m.getDate()-2);const y=m.getTime(),g=[],T=[];if(w.forEach(u=>{$(u.timestamp)>=y?g.push(u):T.push(u)}),g.length<20&&T.length>0){const u=20-g.length,S=T.splice(T.length-u,u);g.unshift(...S)}X(u=>{const S=u.filter(v=>v.isOptimistic),me=u.filter(v=>!v.isOptimistic),Ge=new Set(g.map(v=>v.id)),Te=[...me.filter(v=>!Ge.has(v.id)),...g].sort((v,q)=>$(v.timestamp)-$(q.timestamp));if(r){const v=new Set(Te.map(q=>q.id));fe.current=T.filter(q=>!v.has(q.id))}const Ce=new Set;return[...Te,...S].filter(v=>Ce.has(v.id)?!1:(Ce.add(v.id),!0))})}}catch{console.warn("Chat history service unavailable")}finally{be(!1)}},[Z,X,ee,W,l.length]),te=(e="smooth")=>{ce.current&&ce.current.scrollIntoView({behavior:e})};a.useEffect(()=>{const e=window.location.protocol==="https:"?"wss":"ws",s=M.replace(/^https?:\/\//,""),r=`${e}://${s}/api/chat/ws`,o=()=>{var d;if(((d=de.current)==null?void 0:d.readyState)===WebSocket.OPEN)return;oe("connecting");const c=new WebSocket(r);de.current=c,c.onopen=()=>{oe("connected"),z()},c.onclose=()=>{oe("disconnected"),setTimeout(o,3e3)},c.onmessage=n=>{try{const w=JSON.parse(n.data);if(w.action==="new_message"){const m=w.payload,y=Z(m);F.current&&y.id<=F.current||ee([y]),X(g=>{if(g.some(u=>u.id===y.id))return g;const T=g.findIndex(u=>u.isOptimistic&&u.user===y.user&&u.type===y.type);if(T!==-1){const u=[...g];return u[T]=y,u}return[...g,y]}),Y.current&&setTimeout(()=>te("smooth"),100)}}catch(w){console.error("WS Message Error",w)}}};return o(),()=>{var c;(c=de.current)==null||c.close()}},[ee,Z,X]),a.useEffect(()=>{p&&z()},[p,z]),a.useEffect(()=>{const e=setInterval(()=>{z()},3e3);return()=>clearInterval(e)},[z]);const ze=()=>{if(!P.current)return;const{scrollTop:e,scrollHeight:s,clientHeight:r}=P.current,o=s-e-r<200;if(Fe(!o),e===0)if(fe.current.length>0){const c=fe.current.splice(-20);if(c.length>0){const d=s;f(n=>[...c,...n]),requestAnimationFrame(()=>{if(P.current){const n=P.current.scrollHeight;P.current.scrollTop=n-d}})}}else!ke.current&&!W&&z(!0)};a.useEffect(()=>{if(!p||U!=="chat"||W)return;const e=P.current;if(e){const{scrollTop:s,scrollHeight:r,clientHeight:o}=e,c=r-s-o<250,d=l[l.length-1],n=(d==null?void 0:d.user)===(i==null?void 0:i.UserName);(n||d!=null&&d.isOptimistic||c)&&te(s===0&&!n?"auto":"smooth")}else te("auto")},[l,p,U,W]);const re=async(e,s,r)=>{if(!e&&s==="text")return;const o=ue.current;if(!o){alert("Please login to send messages.");return}const c=Date.now().toString();let d=e;s==="image"&&!e.startsWith("http")&&!e.startsWith("data:")&&(d=`data:image/jpeg;base64,${e}`);const n={id:c,user:o.UserName||"Unknown",fullName:o.FullName||"Me",avatar:o.ProfilePictureURL||"",content:d,timestamp:new Date().toISOString(),type:s,fileID:r,isOptimistic:!0,replyTo:R?{id:R.id,user:R.fullName||R.user,content:R.content,type:R.type}:void 0};f(m=>[...m,n]),s==="text"&&Q(""),le(null);const w=s.charAt(0).toUpperCase()+s.slice(1);try{const m={userName:o.UserName,UserName:o.UserName,type:w,MessageType:w,content:e.trim(),Content:e.trim()};r&&(m.FileID=r,m.fileId=r),n.replyTo&&(m.ReplyTo={ID:n.replyTo.id,User:n.replyTo.user,Content:n.replyTo.content,Type:n.replyTo.type});const y=await fetch(`${M}/api/chat/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!y.ok){const g=await y.text();throw new Error(`Server returned ${y.status}: ${g}`)}O||(L.current.currentTime=0,L.current.play().catch(()=>{}))}catch(m){console.error("Send Error:",m),f(y=>y.filter(g=>g.id!==c)),s==="text"&&Q(e),alert("áž€áž¶ážšáž”áž‰áŸ’áž‡áž¼áž“ážŸáž¶ážšáž”ážšáž¶áž‡áŸáž™ (Send Failed). Please try again.")}},He=async e=>{ge(!0);try{const s=await rt(e),r=await tt(s),o=await fetch(`${M}/api/upload-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileData:r,fileName:`img_${Date.now()}.jpg`,mimeType:"image/jpeg",userName:(i==null?void 0:i.UserName)||"unknown"})}),c=await o.json();if(!o.ok||c.status!=="success")throw new Error(c.message||"Image upload failed");let d=c.fileId||c.id;if(!d&&c.url){const n=c.url.match(/(?:d\/|id=)([^/?&]+)/);n&&n[1]&&(d=n[1])}if(!d)throw new Error("Failed to get File ID");await re(c.url,"image",d)}catch(s){console.error("Image Upload Error:",s),alert("áž€áž¶ážšáž”áž‰áŸ’áž‡áž¼áž“ážšáž¼áž”áž—áž¶áž–áž”ážšáž¶áž‡áŸáž™ (Failed to upload image).")}finally{ge(!1)}},Ve=async e=>{if(confirm("Are you sure you want to delete this message?")){f(s=>s.map(r=>r.id===e?{...r,isDeleted:!0}:r));try{await fetch(`${M}/api/chat/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageId:e,userName:i==null?void 0:i.UserName})})}catch(s){console.error("Delete failed",s)}}},Je=async(e,s)=>{f(r=>r.map(o=>o.id===e?{...o,isPinned:!s}:o));try{await fetch(`${M}/api/chat/pin`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageId:e,isPinned:!s,userName:i==null?void 0:i.UserName})})}catch(r){console.error("Pin failed",r)}},Ye=(e,s)=>{const r=document.createElement("a");r.href=e,r.download=s,document.body.appendChild(r),r.click(),document.body.removeChild(r)},qe=e=>{const s=e.target.value;Q(s);const r=s.split(/[\s\n]+/).pop();r&&r.startsWith("@")?(ve(r.slice(1)),ie(!0)):ie(!1)},Ke=e=>{const s=J.split(/([\s\n]+)/),r=s.length-1;s[r]=`@${e} `,Q(s.join("")),ie(!1),ve("");const o=document.querySelector(".chat-input-area textarea");o&&o.focus()},Qe=e=>e.split(/(@[\w\u1780-\u17FF]+)/g).map((r,o)=>{if(r.startsWith("@")){const c=r.slice(1);if(j.some(n=>n.UserName===c||n.FullName===c)||r.length>2)return t.jsx("span",{className:"text-blue-300 font-bold bg-blue-500/20 px-1 rounded-md mx-0.5",children:r},o)}return t.jsx("span",{children:r},o)});return t.jsxs("div",{className:`chat-widget-container ${p?"":"closed"}`,children:[t.jsxs("div",{className:"chat-header",children:[t.jsxs("div",{className:"title-group flex items-center gap-2",children:[t.jsx("div",{className:`connection-status w-3 h-3 rounded-full ${Ae==="connected"?"bg-green-500 shadow-[0_0_10px_#22c55e]":"bg-yellow-500 animate-pulse"}`}),t.jsx("h3",{className:"font-black text-white uppercase tracking-wider text-sm",children:"Team Chat"})]}),t.jsxs("div",{className:"controls flex items-center gap-2",children:[t.jsx("button",{onClick:()=>{const e=!O;De(e),localStorage.setItem("chatMuted",String(e)),e||Ie().then(s=>{s&&console.log("Notification permission granted via toggle")})},className:"p-2 hover:bg-white/10 rounded-full transition-colors text-gray-400 hover:text-white",children:O?"ðŸ”‡":"ðŸ””"}),t.jsx("button",{onClick:C,className:"p-2 hover:bg-red-500/20 hover:text-red-400 rounded-full transition-colors text-gray-400",children:t.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),t.jsxs("div",{className:"chat-tabs bg-gray-900/50 p-1",children:[t.jsx("button",{onClick:()=>we("chat"),className:`text-xs font-bold uppercase tracking-wider transition-all ${U==="chat"?"active bg-blue-600 text-white shadow-lg":"text-gray-500 hover:text-gray-300"}`,children:"Chat Stream"}),t.jsx("button",{onClick:()=>we("users"),className:`text-xs font-bold uppercase tracking-wider transition-all ${U==="users"?"active bg-blue-600 text-white shadow-lg":"text-gray-500 hover:text-gray-300"}`,children:"Members"})]}),U==="chat"&&Re.length>0&&t.jsxs("div",{className:"bg-gray-900/80 border-b border-gray-800 p-2 flex gap-2 overflow-x-auto custom-scrollbar",children:[t.jsx("div",{className:"flex-shrink-0 flex items-center justify-center w-6 h-6 bg-yellow-500/20 rounded-full",children:t.jsx("svg",{className:"w-3 h-3 text-yellow-500",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2z"})})}),Re.map(e=>t.jsxs("div",{className:"flex-shrink-0 max-w-[200px] bg-gray-800 rounded-lg p-2 text-[10px] border border-gray-700 cursor-pointer hover:bg-gray-700",onClick:()=>{var s;return(s=document.getElementById(`msg-${e.id}`))==null?void 0:s.scrollIntoView({behavior:"smooth",block:"center"})},children:[t.jsx("p",{className:"font-bold text-gray-400 truncate",children:e.fullName}),t.jsx("p",{className:"text-gray-300 truncate",children:e.type==="text"?e.content:`[${e.type}]`})]},e.id))]}),t.jsx("div",{className:"chat-body custom-scrollbar bg-[#0f172a] relative",ref:P,onScroll:ze,children:U==="chat"?t.jsxs("div",{className:"chat-messages p-4 space-y-6 min-h-full pb-20",children:[W?t.jsxs("div",{className:"flex flex-col items-center justify-center py-10 space-y-3",children:[t.jsx(Ue,{size:"md"}),t.jsx("span",{className:"text-xs text-gray-500",children:"Loading history..."})]}):l.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-center opacity-50",children:[t.jsx("svg",{className:"w-16 h-16 text-gray-600 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),t.jsx("p",{className:"text-xs font-black uppercase tracking-widest text-gray-500",children:"No messages yet"}),t.jsx("p",{className:"text-[10px] text-gray-600 mt-1",children:"Start the conversation!"})]}):l.map((e,s)=>{const r=e.user===(i==null?void 0:i.UserName),o=j.find(n=>n.UserName===e.user),c=s===0||l[s-1].user!==e.user,d=e.content.includes("SYSTEM_ALERT")||e.content.includes("NEW ORDER");return t.jsx("div",{id:`msg-${e.id}`,className:`flex flex-col ${r?"items-end":"items-start"} animate-fade-in-up group/msg relative`,children:d?t.jsx("div",{className:"w-full flex justify-center my-2",children:t.jsx("div",{className:"bg-blue-900/40 border border-blue-500/30 rounded-xl px-4 py-2 text-[10px] font-bold text-blue-300 text-center shadow-lg",children:e.content.replace("ðŸ“¢ SYSTEM_ALERT:","").replace("ðŸ“¢ NEW ORDER:","").trim()})}):t.jsxs("div",{className:`flex max-w-[85%] gap-3 ${r?"flex-row-reverse":""}`,children:[t.jsx("div",{className:"flex-shrink-0 w-8 flex flex-col justify-end",children:c?t.jsx(xe,{avatarUrl:(o==null?void 0:o.ProfilePictureURL)||e.avatar,name:(o==null?void 0:o.FullName)||e.fullName,size:"sm",className:"ring-2 ring-white/10"}):t.jsx("div",{className:"w-8"})}),t.jsxs("div",{className:`relative px-4 py-3 shadow-lg transition-all ${r?"bg-blue-600 text-white rounded-2xl rounded-tr-sm":"bg-gray-800 text-gray-200 rounded-2xl rounded-tl-sm border border-white/5"} ${e.isOptimistic?"opacity-70":""} ${e.isDeleted?"italic opacity-60 border-dashed border-gray-600":""}`,children:[e.replyTo&&!e.isDeleted&&t.jsxs("div",{className:`mb-2 p-2 rounded-lg border-l-4 text-xs ${r?"bg-blue-700/50 border-blue-300":"bg-gray-900/50 border-gray-600"}`,children:[t.jsx("p",{className:"font-bold opacity-80",children:e.replyTo.user}),t.jsx("p",{className:"truncate opacity-70",children:e.replyTo.type==="text"?e.replyTo.content:`[${e.replyTo.type}]`})]}),!r&&c&&t.jsx("p",{className:"text-[10px] font-black text-blue-400 mb-1 uppercase tracking-wider",children:(o==null?void 0:o.FullName)||e.fullName}),e.isDeleted?t.jsx("p",{className:"text-sm text-gray-400",children:"ðŸš« This message was deleted"}):t.jsxs(t.Fragment,{children:[e.type==="text"&&t.jsx("p",{className:"leading-relaxed text-sm whitespace-pre-wrap",children:Qe(e.content)}),e.type==="image"&&t.jsx("img",{src:e.content,className:"rounded-xl max-w-full cursor-pointer hover:opacity-90 transition-opacity border border-black/20",onClick:()=>E(e.content),alt:"attachment"}),e.type==="audio"&&t.jsx(it,{src:e.content,isMe:r}),e.type==="video"&&t.jsxs("video",{controls:!0,className:"rounded-xl max-w-full border border-black/20",style:{maxHeight:"200px"},children:[t.jsx("source",{src:e.content,type:"video/mp4"}),"Your browser does not support the video tag."]})]}),t.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1.5",children:[e.isPinned&&t.jsx("svg",{className:"w-3 h-3 text-yellow-500",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2z"})}),t.jsx("p",{className:`text-[9px] font-medium ${r?"text-blue-200":"text-gray-500"}`,children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),e.isOptimistic&&t.jsxs("svg",{className:"w-3 h-3 text-white/50 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})]}),!e.isDeleted&&!e.isOptimistic&&t.jsxs("div",{className:`absolute top-0 ${r?"-left-10":"-right-10"} opacity-0 group-hover/msg:opacity-100 transition-opacity flex flex-col gap-1 p-1`,children:[t.jsx("button",{onClick:()=>le(e),className:"p-1.5 bg-gray-800 text-gray-400 hover:text-white rounded-full shadow border border-gray-700",title:"Reply",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"})})}),t.jsx("button",{onClick:()=>Je(e.id,!!e.isPinned),className:`p-1.5 bg-gray-800 rounded-full shadow border border-gray-700 ${e.isPinned?"text-yellow-500":"text-gray-400 hover:text-white"}`,title:e.isPinned?"Unpin":"Pin",children:t.jsx("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M16 12V4h1V2H7v2h1v8l-2 2v2h5v6l1 1 1-1v-6h5v-2l-2-2z"})})}),(e.type==="image"||e.type==="video")&&t.jsx("button",{onClick:()=>Ye(e.content,`${e.type}_${e.id}.${e.type==="video"?"mp4":"jpg"}`),className:"p-1.5 bg-gray-800 text-gray-400 hover:text-white rounded-full shadow border border-gray-700",title:"Download",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})})}),r&&t.jsx("button",{onClick:()=>Ve(e.id),className:"p-1.5 bg-gray-800 text-red-400 hover:bg-red-900/20 rounded-full shadow border border-gray-700",title:"Delete",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]})]})},e.id+s)}),t.jsx("div",{ref:ce})]}):t.jsx(ot,{users:j,loading:se,onRefresh:pe})}),U==="chat"&&Pe&&t.jsx("button",{onClick:()=>te("smooth"),className:"absolute bottom-24 right-6 p-3 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-900/50 hover:bg-blue-500 transition-all animate-bounce z-50 flex items-center justify-center w-10 h-10 border border-blue-400/30",title:"Scroll to bottom",children:t.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 14l-7 7m0 0l-7-7m7 7V3"})})}),U==="chat"&&t.jsxs("div",{className:"chat-input-area p-3 bg-gray-900 border-t border-gray-800 relative z-20",children:[Be&&t.jsxs("div",{className:"absolute bottom-full left-4 mb-2 bg-gray-800 border border-gray-700 rounded-xl shadow-xl w-64 max-h-60 overflow-y-auto custom-scrollbar z-50 animate-fade-in-up flex flex-col",children:[t.jsx("div",{className:"p-2 sticky top-0 bg-gray-800/95 backdrop-blur border-b border-gray-700 z-10",children:t.jsx("p",{className:"text-[10px] font-black uppercase tracking-widest text-gray-500",children:"Suggested Members"})}),j.filter(e=>{var s,r;return(((s=e.FullName)==null?void 0:s.toLowerCase().includes(G.toLowerCase()))||((r=e.UserName)==null?void 0:r.toLowerCase().includes(G.toLowerCase())))&&e.UserName!==(i==null?void 0:i.UserName)}).slice(0,10).map(e=>t.jsxs("button",{onClick:()=>Ke(e.UserName),className:"w-full flex items-center gap-3 p-2 hover:bg-white/5 transition-colors text-left group border-b border-gray-700/50 last:border-0",children:[t.jsx(xe,{name:e.FullName,avatarUrl:e.ProfilePictureURL,size:"sm",className:"ring-1 ring-white/10"}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-sm font-bold text-gray-200 group-hover:text-blue-400 truncate",children:e.FullName}),t.jsxs("p",{className:"text-[10px] text-gray-500 truncate",children:["@",e.UserName]})]})]},e.UserID)),j.filter(e=>{var s,r;return((s=e.FullName)==null?void 0:s.toLowerCase().includes(G.toLowerCase()))||((r=e.UserName)==null?void 0:r.toLowerCase().includes(G.toLowerCase()))}).length===0&&t.jsx("div",{className:"p-4 text-center text-gray-500 text-[10px] uppercase tracking-wider",children:"No matching members"})]}),R&&t.jsxs("div",{className:"flex items-center justify-between bg-gray-800/80 border-l-4 border-blue-500 p-2 mb-2 rounded-r-lg animate-fade-in-up",children:[t.jsxs("div",{className:"flex flex-col text-xs overflow-hidden",children:[t.jsxs("span",{className:"font-bold text-blue-400",children:["Replying to ",R.fullName||R.user]}),t.jsx("span",{className:"text-gray-400 truncate",children:R.type==="text"?R.content:`[${R.type}]`})]}),t.jsx("button",{onClick:()=>le(null),className:"p-1 hover:bg-gray-700 rounded-full text-gray-500 hover:text-white",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),N?t.jsxs("div",{className:"flex items-center gap-3 bg-gray-800 p-2 rounded-2xl border border-red-500/50 shadow-[0_0_15px_rgba(239,68,68,0.2)] animate-fade-in relative overflow-hidden h-[60px]",children:[t.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none gap-1 px-10",children:[...Array(20)].map((e,s)=>t.jsx("div",{className:"w-1 bg-red-500 rounded-full animate-pulse",style:{height:`${30+Math.random()*50}%`,animationDuration:`${.6+Math.random()*.4}s`,animationDelay:`${Math.random()*.5}s`}},s))}),t.jsxs("div",{className:"flex-shrink-0 w-10 h-10 flex items-center justify-center bg-red-500/10 rounded-full relative z-10 ml-1",children:[t.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-[ping_1.5s_cubic-bezier(0,0,0.2,1)_infinite]"}),t.jsx("div",{className:"absolute w-2 h-2 bg-red-500 rounded-full"})]}),t.jsxs("div",{className:"flex-grow flex flex-col justify-center relative z-10",children:[t.jsx("p",{className:"text-white font-black text-lg font-mono tracking-widest leading-none",children:Se(_)}),t.jsx("p",{className:"text-[9px] text-red-400 font-bold uppercase tracking-widest mt-0.5",children:"Recording..."})]}),t.jsxs("div",{className:"flex gap-2 relative z-10 mr-1",children:[t.jsx("button",{onClick:Oe,className:"p-2.5 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded-full transition-all active:scale-90",title:"Cancel",children:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("button",{onClick:We,className:"p-2.5 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-600/30 hover:bg-blue-500 transition-all active:scale-90 hover:scale-105",title:"Send",children:t.jsx("svg",{className:"w-5 h-5 ml-0.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M5 13l4 4L19 7"})})})]})]}):t.jsxs("div",{className:"flex items-end gap-2 relative",children:[t.jsx("button",{onClick:()=>{var e;return(e=Ne.current)==null?void 0:e.click()},className:"p-3 text-gray-400 hover:text-blue-400 hover:bg-gray-800 rounded-xl transition-all flex-shrink-0 h-[44px] w-[44px] flex items-center justify-center",title:"Attach Image",children:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h14a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),t.jsx("input",{type:"file",ref:Ne,className:"hidden",accept:"image/*",onChange:e=>e.target.files&&He(e.target.files[0])}),t.jsx("div",{className:"flex-grow relative",children:t.jsx("textarea",{value:J,onChange:qe,onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),re(J,"text"))},placeholder:"Type a message...",className:"w-full bg-gray-800 text-white rounded-2xl py-3 pl-4 pr-10 border-transparent focus:border-blue-500 focus:ring-0 resize-none text-sm custom-scrollbar",rows:1,style:{minHeight:"44px",maxHeight:"100px"}})}),J.trim()?t.jsx("button",{onClick:()=>re(J,"text"),className:"p-3 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-600/20 active:scale-95 transition-all hover:bg-blue-500 flex-shrink-0 h-[44px] w-[44px] flex items-center justify-center",children:t.jsx("svg",{className:"w-5 h-5 transform rotate-90",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{d:"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"})})}):t.jsx("button",{onClick:_e,disabled:ye,className:"p-3 bg-gray-800 text-white rounded-xl border border-gray-700 hover:bg-red-500/10 hover:border-red-500/50 hover:text-red-500 transition-all active:scale-95 group flex-shrink-0 h-[44px] w-[44px] flex items-center justify-center",children:t.jsx("svg",{className:"w-5 h-5 group-hover:scale-110 transition-transform",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})})})]}),($e||ye)&&t.jsx("div",{className:"absolute inset-x-0 bottom-full bg-blue-600/90 text-white text-[10px] font-black uppercase tracking-widest text-center py-1",children:"Processing Transfer..."})]})]})};export{pt as default};
