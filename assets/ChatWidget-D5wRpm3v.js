import{r as s,j as t,S as G,A as ie,c as ce,W as L,R as le,f as de}from"./index-BOQEVNqD.js";import{c as ue}from"./imageCompressor-D5vYYzIg.js";import{U as q}from"./UserAvatar-CwCKKgcU.js";const me=["audio/mp4","audio/webm;codecs=opus","audio/webm","audio/ogg;codecs=opus","audio/ogg"],he=()=>{const[u,x]=s.useState(!1),a=s.useRef(null),f=s.useRef([]),p=s.useRef("audio/webm");return{isRecording:u,startRecording:async()=>{if(!u)try{const c=await navigator.mediaDevices.getUserMedia({audio:!0}),m=me.find(l=>MediaRecorder.isTypeSupported(l));if(!m){alert("Your browser does not support any of the required audio recording formats."),console.error("No supported audio MIME types found.");return}p.current=m,console.log(`Using MIME type for recording: ${m}`),a.current=new MediaRecorder(c,{mimeType:m}),f.current=[],a.current.ondataavailable=l=>{f.current.push(l.data)},a.current.onstop=()=>{c.getTracks().forEach(l=>l.stop())},a.current.start(),x(!0)}catch(c){console.error("Error starting audio recording:",c),c instanceof DOMException&&(c.name==="NotAllowedError"||c.name==="PermissionDeniedError")?alert("áž€áž¶ážšáž¢áž“áž»áž‰áŸ’áž‰áž¶ážáž±áŸ’áž™áž”áŸ’ážšáž¾áž˜áž¸áž€áŸ’ážšáž¼áž áŸ’ážœáž¼áž“ážáŸ’ážšáž¼ážœáž”áž¶áž“áž”ážŠáž·ážŸáŸáž’áŸ” ážŸáž¼áž˜áž¢áž“áž»áž‰áŸ’áž‰áž¶ážáž±áŸ’áž™áž…áž¼áž›áž”áŸ’ážšáž¾áž˜áž¸áž€áŸ’ážšáž¼áž áŸ’ážœáž¼áž“áž“áŸ…áž€áŸ’áž“áž»áž„áž€áž¶ážšáž€áŸ†ážŽážáŸ‹áž€áž˜áŸ’áž˜ážœáž·áž’áž¸ážšáž»áž€ážšáž€ážšáž”ážŸáŸ‹áž¢áŸ’áž“áž€ ážŠáž¾áž˜áŸ’áž”áž¸áž”áŸ’ážšáž¾áž˜áž»ážáž„áž¶ážšáž“áŸáŸ‡áŸ”"):alert("áž˜áž·áž“áž¢áž¶áž…áž…áž¶áž”áŸ‹áž•áŸ’ážáž¾áž˜áž€áž¶ážšážážážŸáŸ†áž¡áŸáž„áž”áž¶áž“áž‘áŸáŸ” ážŸáž¼áž˜áž”áŸ’ážšáž¶áž€ážŠážáž¶áž¢áŸ’áž“áž€áž”áž¶áž“áž—áŸ’áž‡áž¶áž”áŸ‹áž˜áž¸áž€áŸ’ážšáž¼áž áŸ’ážœáž¼áž“ áž áž¾áž™áž”áž¶áž“áž•áŸ’ážáž›áŸ‹áž€áž¶ážšáž¢áž“áž»áž‰áŸ’áž‰áž¶ážáŸ”")}},stopRecording:()=>new Promise(c=>{if(!a.current||!u){c(null);return}a.current.onstop=()=>{const m=new Blob(f.current,{type:p.current});a.current&&a.current.stream.getTracks().forEach(l=>l.stop()),c(m)},a.current.stop(),x(!1)})}},xe=({src:u,isMe:x=!1})=>{const a=s.useRef(null),[f,p]=s.useState(!1),[y,b]=s.useState(0),[c,m]=s.useState(0),[l,S]=s.useState(!1),[j,v]=s.useState(null),[g]=s.useState(()=>Array.from({length:20},()=>Math.random()*.5+.3));s.useEffect(()=>{const r=a.current;if(!r)return;const d=()=>{r.duration&&isFinite(r.duration)&&(b(r.duration),S(!0),v(null))},h=()=>m(r.currentTime),T=()=>{p(!1),m(0)},M=()=>{console.error("Audio Error",r.error),v("Error playing audio"),S(!1)};return r.addEventListener("loadedmetadata",d),r.addEventListener("canplay",d),r.addEventListener("timeupdate",h),r.addEventListener("ended",T),r.addEventListener("error",M),p(!1),S(!1),m(0),r.load(),()=>{r.removeEventListener("loadedmetadata",d),r.removeEventListener("canplay",d),r.removeEventListener("timeupdate",h),r.removeEventListener("ended",T),r.removeEventListener("error",M)}},[u]);const D=()=>{!l||!a.current||(f?(a.current.pause(),p(!1)):(document.querySelectorAll("audio").forEach(r=>{r!==a.current&&r.pause()}),a.current.play().catch(r=>console.error("Play failed",r)),p(!0)))},w=r=>{if(!isFinite(r)||r<0)return"0:00";const d=Math.floor(r/60),h=Math.floor(r%60);return`${d}:${h<10?"0":""}${h}`};return j?t.jsx("div",{className:"text-[10px] text-red-300 bg-red-900/20 px-2 py-1 rounded",children:"Audio Unavailable"}):t.jsxs("div",{className:`flex items-center gap-3 p-1 rounded-full min-w-[200px] transition-all ${x?"text-white":"text-gray-800 dark:text-white"}`,children:[t.jsx("audio",{ref:a,src:u,preload:"metadata"}),t.jsx("button",{onClick:D,disabled:!l,className:`w-8 h-8 flex items-center justify-center rounded-full shadow-md transition-all active:scale-90 flex-shrink-0 ${x?"bg-white text-blue-600 hover:bg-gray-100":"bg-blue-600 text-white hover:bg-blue-500"}`,children:l?f?t.jsx("svg",{className:"w-3 h-3 fill-current",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})}):t.jsx("svg",{className:"w-3 h-3 fill-current ml-0.5",viewBox:"0 0 24 24",children:t.jsx("path",{d:"M8 5v14l11-7z"})}):t.jsx(G,{size:"sm"})}),t.jsxs("div",{className:"flex flex-col flex-grow min-w-0 gap-1",children:[t.jsx("div",{className:"flex items-center gap-[2px] h-4 w-full",children:g.map((r,d)=>{const h=d/g.length<c/(y||1);return t.jsx("div",{className:`w-1 rounded-full transition-all duration-100 ${h?x?"bg-blue-200":"bg-blue-500":x?"bg-blue-800":"bg-gray-600"}`,style:{height:f?`${Math.max(20,r*100*(Math.random()*.5+.8))}%`:`${r*100}%`,opacity:h?1:.5}},d)})}),t.jsx("div",{className:`text-[9px] font-mono font-bold text-right ${x?"text-blue-100":"text-gray-400"}`,children:w(f?c:y)})]})]})},fe=new Audio("https://raw.githubusercontent.com/NateeDev/aistudio-template-order-management/main/public/assets/notification.mp3"),pe=le.memo(xe),we=({isOpen:u,onClose:x})=>{const{currentUser:a,appData:f,previewImage:p,setUnreadCount:y}=s.useContext(ie),b=s.useMemo(()=>a?`chatHistoryCache_${a.UserName}`:null,[a]),{isRecording:c,startRecording:m,stopRecording:l}=he(),[S,j]=s.useState(0),v=s.useRef(null),[g,D]=s.useState(()=>{if(!b)return[];try{const e=localStorage.getItem(b);return e&&e!=="undefined"?JSON.parse(e):[]}catch{return[]}}),[w,r]=s.useState(f.users||[]),[d,h]=s.useState(""),[T,M]=s.useState(!1),[z,W]=s.useState(!1),[$,Q]=s.useState(()=>localStorage.getItem("chatMuted")==="true"),[_,H]=s.useState(!1),[X,B]=s.useState("disconnected"),[N,V]=s.useState("chat"),J=s.useRef(null),F=s.useRef(null),C=s.useRef(null),K=s.useRef(u);K.current=u;const Z=async()=>{await m(),j(0),v.current=setInterval(()=>{j(e=>e+1)},1e3)},ee=async()=>{await l(),v.current&&clearInterval(v.current),j(0)},te=async()=>{v.current&&clearInterval(v.current),W(!0);try{const e=await l();if(e){const n=new FileReader;n.readAsDataURL(e),n.onloadend=async()=>{const i=n.result.split(",")[1];await A(i,"audio")}}}catch(e){console.error("Failed to send audio",e)}finally{W(!1),j(0)}},se=e=>{const n=Math.floor(e/60),o=e%60;return`${n}:${o<10?"0":""}${o}`},ae=async()=>{try{const e=await fetch(`${L}/api/users`);if(e.ok){const n=await e.json();n.status==="success"&&r(n.data)}}catch(e){console.error("User fetch failed",e)}},I=s.useCallback(e=>{D(n=>{const o=typeof e=="function"?e(n):e;return b&&localStorage.setItem(b,JSON.stringify(o)),o})},[b]),U=s.useCallback(e=>{const n=w.find(o=>o.UserName===e.UserName);return{id:e.Timestamp,user:e.UserName,fullName:(n==null?void 0:n.FullName)||e.UserName,avatar:(n==null?void 0:n.ProfilePictureURL)||"",content:e.MessageType==="image"?ce(e.Content):e.MessageType==="audio"?`${L}/api/chat/audio/${e.FileID}`:e.Content,timestamp:e.Timestamp,type:e.MessageType,fileID:e.FileID}},[w]),O=s.useCallback(async()=>{g.length===0&&H(!0);try{const n=await(await fetch(`${L}/api/chat/messages`)).json();if(n.status==="success"){const o=n.data.map(U);I(o.sort((i,k)=>new Date(i.timestamp).getTime()-new Date(k.timestamp).getTime()))}}catch(e){console.error("Fetch history failed:",e)}finally{H(!1)}},[U,I,g.length]),Y=s.useCallback(()=>{var i;if(((i=C.current)==null?void 0:i.readyState)===WebSocket.OPEN)return;B("connecting");const e=window.location.protocol==="https:"?"wss":"ws",n=L.replace(/^https?:\/\//,""),o=new WebSocket(`${e}://${n}/api/chat/ws`);C.current=o,o.onopen=()=>{B("connected")},o.onclose=()=>{B("disconnected")},o.onmessage=k=>{try{const R=JSON.parse(k.data);if(R.action==="new_message"){const P=U(R.payload);I(E=>E.some(oe=>oe.id===P.id)?E:[...E,P]),P.user!==(a==null?void 0:a.UserName)&&!K.current&&y(E=>E+1),P.user!==(a==null?void 0:a.UserName)&&!$&&fe.play().catch(()=>{})}}catch(R){console.error("WS Message Error",R)}}},[U,a,$,y,I]);s.useEffect(()=>(u&&(ae(),O(),Y()),()=>{C.current&&(C.current.close(),C.current=null)}),[u,Y,O]);const re=()=>{F.current&&F.current.scrollIntoView({behavior:"smooth"})};s.useEffect(()=>{N==="chat"&&re()},[g,N,u,_]);const A=async(e,n)=>{if(e.trim())try{await fetch(`${L}/api/chat/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:a==null?void 0:a.UserName,type:n,content:e.trim()})}),n==="text"&&h("")}catch{alert("áž”ážŽáŸ’ážáž¶áž‰áž˜áž¶áž“áž”áž‰áŸ’áž áž¶")}},ne=async e=>{M(!0);try{const n=await ue(e),o=await de(n);await A(o,"image")}finally{M(!1)}};return t.jsxs("div",{className:`chat-widget-container ${u?"":"closed"}`,children:[t.jsxs("div",{className:"chat-header",children:[t.jsxs("div",{className:"title-group flex items-center gap-2",children:[t.jsx("div",{className:`connection-status w-3 h-3 rounded-full ${X==="connected"?"bg-green-500 shadow-[0_0_10px_#22c55e]":"bg-yellow-500 animate-pulse"}`}),t.jsx("h3",{className:"font-black text-white uppercase tracking-wider text-sm",children:"Team Chat"})]}),t.jsxs("div",{className:"controls flex items-center gap-2",children:[t.jsx("button",{onClick:()=>{const e=!$;Q(e),localStorage.setItem("chatMuted",String(e))},className:"p-2 hover:bg-white/10 rounded-full transition-colors text-gray-400 hover:text-white",children:$?"ðŸ”‡":"ðŸ””"}),t.jsx("button",{onClick:x,className:"p-2 hover:bg-red-500/20 hover:text-red-400 rounded-full transition-colors text-gray-400",children:t.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})]}),t.jsxs("div",{className:"chat-tabs bg-gray-900/50 p-1",children:[t.jsx("button",{onClick:()=>V("chat"),className:`text-xs font-bold uppercase tracking-wider transition-all ${N==="chat"?"active bg-blue-600 text-white shadow-lg":"text-gray-500 hover:text-gray-300"}`,children:"Chat Stream"}),t.jsx("button",{onClick:()=>V("users"),className:`text-xs font-bold uppercase tracking-wider transition-all ${N==="users"?"active bg-blue-600 text-white shadow-lg":"text-gray-500 hover:text-gray-300"}`,children:"Members"})]}),t.jsx("div",{className:"chat-body custom-scrollbar bg-[#0f172a] relative",children:N==="chat"?t.jsxs("div",{className:"chat-messages p-4 space-y-6 min-h-full",children:[_?t.jsxs("div",{className:"flex flex-col items-center justify-center py-10 space-y-3",children:[t.jsx(G,{size:"md"}),t.jsx("span",{className:"text-xs text-gray-500",children:"Loading history..."})]}):g.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-center opacity-50",children:[t.jsx("svg",{className:"w-16 h-16 text-gray-600 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),t.jsx("p",{className:"text-xs font-black uppercase tracking-widest text-gray-500",children:"No messages yet"}),t.jsx("p",{className:"text-[10px] text-gray-600 mt-1",children:"Start the conversation!"})]}):g.map((e,n)=>{const o=e.user===(a==null?void 0:a.UserName),i=w.find(R=>R.UserName===e.user),k=n===0||g[n-1].user!==e.user;return t.jsx("div",{className:`flex flex-col ${o?"items-end":"items-start"} animate-fade-in-up`,children:t.jsxs("div",{className:`flex max-w-[85%] gap-3 ${o?"flex-row-reverse":""}`,children:[t.jsx("div",{className:"flex-shrink-0 w-8 flex flex-col justify-end",children:k?t.jsx(q,{avatarUrl:(i==null?void 0:i.ProfilePictureURL)||e.avatar,name:(i==null?void 0:i.FullName)||e.fullName,size:"sm",className:"ring-2 ring-white/10"}):t.jsx("div",{className:"w-8"})}),t.jsxs("div",{className:`relative px-4 py-3 shadow-lg ${o?"bg-blue-600 text-white rounded-2xl rounded-tr-sm":"bg-gray-800 text-gray-200 rounded-2xl rounded-tl-sm border border-white/5"}`,children:[!o&&k&&t.jsx("p",{className:"text-[10px] font-black text-blue-400 mb-1 uppercase tracking-wider",children:(i==null?void 0:i.FullName)||e.fullName}),e.type==="text"&&t.jsx("p",{className:"leading-relaxed text-sm whitespace-pre-wrap",children:e.content}),e.type==="image"&&t.jsx("img",{src:e.content,className:"rounded-xl max-w-full cursor-pointer hover:opacity-90 transition-opacity border border-black/20",onClick:()=>p(e.content),alt:"attachment"}),e.type==="audio"&&t.jsx(pe,{src:e.content,isMe:o}),t.jsx("p",{className:`text-[9px] mt-1.5 text-right font-medium ${o?"text-blue-200":"text-gray-500"}`,children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},e.id+n)}),t.jsx("div",{ref:F})]}):t.jsx("div",{className:"p-4 space-y-3",children:w.map(e=>t.jsxs("div",{className:"flex items-center gap-4 p-3 rounded-2xl bg-gray-800/40 border border-white/5 hover:bg-gray-800 transition-colors cursor-default",children:[t.jsx(q,{avatarUrl:e.ProfilePictureURL,name:e.FullName,size:"md",className:"ring-2 ring-blue-500/20"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-black text-white",children:e.FullName}),t.jsxs("p",{className:"text-[10px] text-gray-500 font-mono uppercase tracking-wider",children:["@",e.UserName]})]}),t.jsx("div",{className:`ml-auto w-2 h-2 rounded-full ${e.IsSystemAdmin?"bg-yellow-500":"bg-blue-500"}`})]},e.UserName))})}),N==="chat"&&t.jsxs("div",{className:"p-3 bg-gray-900 border-t border-gray-800",children:[c?t.jsxs("div",{className:"flex items-center gap-3 bg-red-900/20 p-2 rounded-2xl border border-red-500/30 animate-pulse",children:[t.jsx("div",{className:"w-10 h-10 flex items-center justify-center bg-red-600 rounded-full shadow-lg shadow-red-600/40",children:t.jsx("div",{className:"w-4 h-4 bg-white rounded-sm animate-pulse"})}),t.jsxs("div",{className:"flex-grow text-center",children:[t.jsx("p",{className:"text-red-400 font-black text-sm font-mono tracking-widest",children:se(S)}),t.jsx("p",{className:"text-[8px] text-red-500 font-bold uppercase tracking-wider",children:"Recording..."})]}),t.jsx("button",{onClick:ee,className:"p-2 text-gray-400 hover:text-white transition-colors",children:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("button",{onClick:te,className:"p-2 bg-blue-600 text-white rounded-xl shadow-lg hover:bg-blue-500 transition-all active:scale-95",children:t.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})})]}):t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("button",{onClick:()=>{var e;return(e=J.current)==null?void 0:e.click()},className:"p-3 text-gray-400 hover:text-blue-400 hover:bg-gray-800 rounded-xl transition-all",title:"Attach Image",children:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h14a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),t.jsx("input",{type:"file",ref:J,className:"hidden",accept:"image/*",onChange:e=>e.target.files&&ne(e.target.files[0])}),t.jsx("div",{className:"flex-grow relative",children:t.jsx("textarea",{value:d,onChange:e=>h(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),A(d,"text"))},placeholder:"Type a message...",className:"w-full bg-gray-800 text-white rounded-2xl py-3 pl-4 pr-10 border-transparent focus:border-blue-500 focus:ring-0 resize-none text-sm max-h-24 custom-scrollbar",rows:1,style:{minHeight:"44px"}})}),d.trim()?t.jsx("button",{onClick:()=>A(d,"text"),className:"p-3 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-600/20 active:scale-95 transition-all hover:bg-blue-500",children:t.jsx("svg",{className:"w-5 h-5 transform rotate-90",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{d:"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"})})}):t.jsx("button",{onClick:Z,disabled:z,className:"p-3 bg-gray-800 text-white rounded-xl border border-gray-700 hover:bg-red-500/20 hover:border-red-500/50 hover:text-red-500 transition-all active:scale-95 group",children:t.jsx("svg",{className:"w-5 h-5 group-hover:scale-110 transition-transform",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})})})]}),(T||z)&&t.jsx("div",{className:"absolute inset-x-0 bottom-full bg-blue-600/90 text-white text-[10px] font-black uppercase tracking-widest text-center py-1",children:"Processing Transfer..."})]})]})};export{we as default};
