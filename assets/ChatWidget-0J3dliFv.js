import{r as a,j as t,S as J,A as X,c as G,W as k,R as Y,f as q}from"./index-nXke7g0V.js";import{c as O}from"./imageCompressor-D5vYYzIg.js";import{U as _}from"./UserAvatar-a-gFHuqz.js";const Q=({src:l})=>{const j=a.useRef(null),o=a.useRef(null),[S,h]=a.useState(!1),[x,f]=a.useState(0),[b,w]=a.useState(0),[u,M]=a.useState(!1),[g,v]=a.useState(null);a.useEffect(()=>{const s=j.current;if(!s)return;const i=()=>{s.duration&&isFinite(s.duration)&&(f(s.duration),M(!0),v(null))},c=()=>{w(s.currentTime)},p=()=>{h(!1),w(0)},d=()=>{const m=s.error;console.error(`Media Error: Code ${m==null?void 0:m.code}, Message: ${m==null?void 0:m.message}`);let R="Could not play audio.";(m==null?void 0:m.code)===4&&(R="Audio format not supported or source unavailable."),v(R),M(!1)},N=()=>{console.warn("Media playback stalled due to insufficient data.")};return s.addEventListener("canplay",i),s.addEventListener("timeupdate",c),s.addEventListener("ended",p),s.addEventListener("error",d),s.addEventListener("stalled",N),s.src!==l&&(h(!1),M(!1),v(null),f(0),w(0),l?(s.src=l,s.load()):(s.pause(),s.removeAttribute("src"),s.src="",s.load())),()=>{s.removeEventListener("canplay",i),s.removeEventListener("timeupdate",c),s.removeEventListener("ended",p),s.removeEventListener("error",d),s.removeEventListener("stalled",N)}},[l]);const z=()=>{if(!u||g)return;const s=j.current;if(s)if(S)s.pause(),h(!1);else{h(!0);const i=s.play();i!==void 0&&i.catch(c=>{c.name!=="AbortError"&&(console.error("Playback failed:",c),v("Playback failed."),h(!1))})}},U=s=>{const i=j.current,c=o.current;if(!u||!i||!c)return;const p=c.getBoundingClientRect(),d=s.clientX-p.left,N=Math.min(Math.max(d/c.offsetWidth,0),1);i.currentTime=N*x,w(i.currentTime)},y=s=>{if(!isFinite(s)||s<0)return"0:00";const i=Math.floor(s/60),c=Math.floor(s%60);return`${i}:${c<10?"0":""}${c}`},P=x>0?b/x*100:0;return g?t.jsx("div",{className:"text-red-400 text-xs px-2 py-1 flex items-center",children:g}):t.jsxs("div",{className:"audio-player",children:[t.jsx("video",{ref:j,preload:"metadata",style:{display:"none"},playsInline:!0}),t.jsx("button",{onClick:z,className:"play-pause-btn","aria-label":S?"Pause":"Play",disabled:!u,children:u?S?t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}):t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:t.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z",clipRule:"evenodd"})}):t.jsx(J,{size:"sm"})}),t.jsxs("div",{className:"progress-bar-container",ref:o,onClick:U,children:[t.jsx("div",{className:"progress-bar-fill",style:{width:`${P}%`}}),t.jsx("div",{className:"progress-thumb",style:{left:`${P}%`}})]}),t.jsx("span",{className:"time-display",children:u?`${y(b)}/${y(x)}`:"-:--"})]})},Z=new Audio("https://raw.githubusercontent.com/NateeDev/aistudio-template-order-management/main/public/assets/notification.mp3"),ee=Y.memo(Q),ne=({isOpen:l,onClose:j})=>{const{currentUser:o,appData:S,previewImage:h,setUnreadCount:x}=a.useContext(X),f=a.useMemo(()=>o?`chatHistoryCache_${o.UserName}`:null,[o]),[b,w]=a.useState(()=>{if(!f)return[];try{const e=localStorage.getItem(f);return e&&e!=="undefined"?JSON.parse(e):[]}catch{return[]}}),[u,M]=a.useState(S.users||[]),[g,v]=a.useState(""),[z,U]=a.useState(!1),[y,P]=a.useState(()=>localStorage.getItem("chatMuted")==="true"),[s,i]=a.useState(b.length===0),[c,p]=a.useState("connecting"),[d,N]=a.useState("chat"),[m,R]=a.useState(0),F=a.useRef(null),B=a.useRef(null),A=a.useRef(null),L=a.useRef(l);L.current=l;const V=async()=>{try{const e=await fetch(`${k}/api/users`);if(e.ok){const n=await e.json();n.status==="success"&&M(n.data)}}catch(e){console.error("User fetch failed",e)}};a.useEffect(()=>{l&&V()},[l]);const T=a.useCallback(e=>{w(n=>{const r=typeof e=="function"?e(n):e;return f&&localStorage.setItem(f,JSON.stringify(r)),r})},[f]),$=a.useCallback(e=>{const n=u.find(r=>r.UserName===e.UserName);return{id:e.Timestamp,user:e.UserName,fullName:(n==null?void 0:n.FullName)||e.UserName,avatar:(n==null?void 0:n.ProfilePictureURL)||"",content:e.MessageType==="image"?G(e.Content):e.MessageType==="audio"?`${k}/api/chat/audio/${e.FileID}`:e.Content,timestamp:e.Timestamp,type:e.MessageType,fileID:e.FileID}},[u]),W=a.useCallback(async()=>{try{const n=await(await fetch(`${k}/api/chat/messages`)).json();if(n.status==="success"){const r=n.data.map($);T(r.sort((C,E)=>new Date(C.timestamp).getTime()-new Date(E.timestamp).getTime()))}}catch(e){console.error(e)}finally{i(!1)}},[$,T]),H=a.useCallback(()=>{var n;if(((n=A.current)==null?void 0:n.readyState)<2)return;p("connecting");const e=new WebSocket(k.replace(/^http/,"ws")+"/api/chat/ws");A.current=e,e.onopen=()=>{p("connected"),R(0),W()},e.onclose=()=>{p("disconnected"),L.current&&R(r=>r+1)},e.onmessage=r=>{const C=JSON.parse(r.data);if(C.action==="new_message"){const E=$(C.payload);T(D=>[...D,E]),E.user!==(o==null?void 0:o.UserName)&&!L.current&&x(D=>D+1),E.user!==(o==null?void 0:o.UserName)&&!y&&Z.play().catch(()=>{})}}},[$,W,o,y,x,T]);a.useEffect(()=>(l&&H(),()=>{var e;return(e=A.current)==null?void 0:e.close()}),[l,H]),a.useEffect(()=>{var e;d==="chat"&&((e=B.current)==null||e.scrollIntoView({behavior:"smooth"}))},[b,d]);const I=async(e,n)=>{if(e.trim())try{await fetch(`${k}/api/chat/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userName:o==null?void 0:o.UserName,type:n,content:e.trim()})}),n==="text"&&v("")}catch{alert("áž”ážŽáŸ’ážáž¶áž‰áž˜áž¶áž“áž”áž‰áŸ’áž áž¶")}},K=async e=>{U(!0);try{const n=await O(e),r=await q(n);await I(r,"image")}finally{U(!1)}};return t.jsxs("div",{className:`chat-widget-container ${l?"":"closed"}`,children:[t.jsxs("div",{className:"chat-header",children:[t.jsxs("div",{className:"title-group",children:[t.jsx("div",{className:`connection-status ${c==="connected"?"connected":"connecting"}`}),t.jsx("h3",{children:"áž‡áž‡áŸ‚áž€áž€áŸ†ážŸáž¶áž“áŸ’áž"})]}),t.jsxs("div",{className:"controls",children:[t.jsx("button",{onClick:()=>P(!y),children:y?"ðŸ”‡":"ðŸ””"}),t.jsx("button",{onClick:j,children:"âœ•"})]})]}),t.jsxs("div",{className:"chat-tabs",children:[t.jsx("button",{onClick:()=>N("chat"),className:d==="chat"?"active":"",children:"áž‡áž‡áŸ‚áž€"}),t.jsx("button",{onClick:()=>N("users"),className:d==="users"?"active":"",children:"áž¢áŸ’áž“áž€áž”áŸ’ážšáž¾áž”áŸ’ážšáž¶ážŸáŸ‹"})]}),t.jsx("div",{className:"chat-body custom-scrollbar",children:d==="chat"?t.jsxs("div",{className:"chat-messages p-4 space-y-4",children:[s?t.jsx(J,{}):b.map(e=>{const n=e.user===(o==null?void 0:o.UserName),r=u.find(C=>C.UserName===e.user);return t.jsx("div",{className:`flex ${n?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`flex max-w-[80%] gap-2 ${n?"flex-row-reverse":""}`,children:[t.jsx(_,{avatarUrl:(r==null?void 0:r.ProfilePictureURL)||e.avatar,name:(r==null?void 0:r.FullName)||e.fullName,size:"sm"}),t.jsxs("div",{className:`p-3 rounded-2xl text-sm ${n?"bg-blue-600 text-white rounded-tr-none":"bg-gray-800 text-gray-200 rounded-tl-none"}`,children:[!n&&t.jsx("p",{className:"text-[10px] font-black text-blue-400 mb-1",children:(r==null?void 0:r.FullName)||e.fullName}),e.type==="text"&&t.jsx("p",{className:"leading-relaxed",children:e.content}),e.type==="image"&&t.jsx("img",{src:e.content,className:"rounded-lg max-w-full cursor-pointer",onClick:()=>h(e.content)}),e.type==="audio"&&t.jsx(ee,{src:e.content}),t.jsx("p",{className:"text-[9px] mt-1 opacity-50 text-right",children:new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},e.id)}),t.jsx("div",{ref:B})]}):t.jsx("div",{className:"p-4 space-y-3",children:u.map(e=>t.jsxs("div",{className:"flex items-center gap-3 p-2 rounded-xl hover:bg-gray-800 transition-colors",children:[t.jsx(_,{avatarUrl:e.ProfilePictureURL,name:e.FullName,size:"md"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-bold text-white",children:e.FullName}),t.jsxs("p",{className:"text-xs text-gray-500",children:["@",e.UserName]})]})]},e.UserName))})}),d==="chat"&&t.jsxs("div",{className:"p-4 bg-gray-900 border-t border-gray-800 flex items-center gap-2",children:[t.jsx("button",{onClick:()=>{var e;return(e=F.current)==null?void 0:e.click()},className:"p-2 text-gray-400 hover:text-blue-400 transition-colors",children:"ðŸ“Ž"}),t.jsx("input",{type:"file",ref:F,className:"hidden",onChange:e=>e.target.files&&K(e.target.files[0])}),t.jsx("input",{type:"text",value:g,onChange:e=>v(e.target.value),onKeyDown:e=>e.key==="Enter"&&I(g,"text"),placeholder:"ážœáž¶áž™ážŸáž¶ážš...",className:"form-input flex-grow !bg-gray-800"}),t.jsx("button",{onClick:()=>I(g,"text"),className:"p-2 bg-blue-600 text-white rounded-xl shadow-lg active:scale-95 transition-all",children:t.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{d:"M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"})})})]})]})};export{ne as default};
